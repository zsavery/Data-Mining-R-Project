---
title: 'Project 2: Building a Safer Health System'
output:
  word_document: default
  html_notebook: default
---

```{r}
if(!require(pacman)) install.packages(pacman)
library(pacman)
pacman::p_load(tidyverse, psych, readxl, RColorBrewer, lubridate, dplyr)
```

```{r}
#Plugs file into variable
ICUEvents <- read_excel("ICUEvents.xlsx")
```

```{r}
newICU <- ICUEvents


```

-   Using R, perform a complete analysis of the dataset (with graphs) representing, for example,

-   frequencies of medical errors

-   medical errors correlation with

    -   day of the week
    -   time of the day
    -   staff member who made the error

-   Since the dependent attribute Type_of_Error has multiple values (levels), select one type of error, you will train your classifier

-   Check that the error is sufficiently represented in the dataset.

-   Clean and prepare your data, using the methods seen in class

-   Train your classifier.

-   Write a report documenting your work: Dataset description, machine learning method and why it is suitable, Training and testing datasets, and the model evaluation.

```{r}
# Lets you view document
# view(newICU)
```

```{r}
# Remove useless column
newICU <- subset(newICU, select= -...11)
```

```{r}
#Summarizes doc
summary(newICU)
```

```{r}
#Gives you the data types of features
str(newICU)
```

```{r}
#Displays doc
newICU
```

```{r}
#Gives you names of features
names(newICU)
```

```{r}
# Factor 
newICU$`Date-of-error` <- as.Date(newICU$`Date-of-error`, tryFormats = c("%d-%m-%Y", "%d/%m/%y"))
#newICU$`Time-of-error` <- as.Date(newICU$`Time-of-error`, tryFormats = c("%h:%m"))
#newICU

```

```{r}
newICU$`Error-category` <- factor(newICU$`Error-category`)
```

```{r}
newICU$`Type-of-error` <- factor(newICU$`Type-of-error`)
newICU$`Cause-of-error` <- factor(newICU$`Cause-of-error`)
```

```{r}
newICU$`Contributing-factor` <- factor(newICU$`Contributing-factor`)
newICU$`Medication-process-node` <- factor(newICU$`Medication-process-node`)
newICU$`Staff-type-initiated-error` <- factor(newICU$`Staff-type-initiated-error`)
newICU$`Staff-type-perpetuated-error` <- factor(newICU$`Staff-type-perpetuated-error`)
newICU$`Action-taken` <- factor(newICU$`Action-taken`)
newICU$`Staff-type-discovered-error` <- factor(newICU$`Staff-type-discovered-error`)

```

```{r}
summary(newICU)
```

```{r}
ggplot(data = newICU, mapping = aes(`Error-category`)) + 
  geom_bar() + 
  scale_fill_brewer(palette="Dark2")
```

```{r}
count_error_category <- newICU %>%
  count(`Error-category`)
?palette

```

```{r}
ggplot(count_error_category, aes(x = `Error-category`, y = n)) +
         geom_bar(stat = 'identity') + geom_text(aes(label = n, vjust = -.45) )
  
```

```{r}


pairs.panels(newICU[c('Error-category', 'Date-of-error', 'Contributing-factor', 'Medication-process-node', 'Location-of-error', 'Type-of-error', 'Staff-type-initiated-error', 'Staff-type-perpetuated-error', 'Staff-type-discovered-error')])
```

```{r}
Improper_doseICU <- subset(newICU, `Type-of-error` =='Improper dose/quantity')
Improper_doseICU <- subset(Improper_doseICU, select= c(`Error-category`,  `Date-of-error`, `Contributing-factor`, `Medication-process-node`, `Location-of-error`, `Staff-type-initiated-error`, `Staff-type-perpetuated-error`, `Staff-type-discovered-error`))
```


```{r}
pairs.panels(Improper_doseICU[c('Error-category', 'Date-of-error', 'Contributing-factor', 'Medication-process-node', 'Location-of-error', 'Staff-type-initiated-error')])

```
```{r}
fit_Improper_dose <- lm(`Error-category` ~ `Date-of-error` + `Contributing-factor` + `Medication-process-node` + `Location-of-error` + `Staff-type-initiated-error` + `Staff-type-perpetuated-error` + `Staff-type-discovered-error`, data= Improper_doseICU)
```
```{r}
fit_Improper_dose2 <- lm(`Error-category` ~ `Location-of-error` + `Staff-type-initiated-error` + `Staff-type-perpetuated-error` + `Staff-type-discovered-error`, data= Improper_doseICU)
```

```{r}
fit_Improper_dose
```
```{r}
fit_Improper_dose2
```
```{r}
Improper_doseICU$`Staff-type-initiated-error` <- as.factor(Improper_doseICU$`Staff-type-initiated-error`)

count_2 <- Improper_doseICU %>%
  count(`Staff-type-initiated-error`)
frequency(Improper_doseICU$`Staff-type-initiated-error`)
```

```{r}

# predict_Improper_dose <- predict(fit_Improper_dose, Improper_doseICU)

```

```{r}
# x <- Improper_doseICU[c('Error-category', 'Location-of-error', 'Staff-type-initiated-error', 'Staff-type-perpetuated-error', 'Staff-type-discovered-error')]
# 
# predict_Improper_dose2 <- predict(fit_Improper_dose2, x)
```

