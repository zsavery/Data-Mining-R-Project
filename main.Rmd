---
title: 'Project 2: Building a Safer Health System'
output:
  word_document: default
  html_notebook: default
---

```{r}
if(!require(pacman)) install.packages(pacman)
library(pacman)
pacman::p_load(tidyverse, psych, readxl, RColorBrewer, lubridate, dplyr)
```

```{r}
#Plugs file into variable
ICUEvents <- read_excel("ICUEvents.xlsx")
```
```{r}
names(ICUEvents)
```

```{r}
newICU <- ICUEvents
newICU <- newICU[complete.cases(newICU["Day-of-week"]), ]

```


-   Using R, perform a complete analysis of the dataset (with graphs) representing, for example,

-   frequencies of medical errors

-   medical errors correlation with

    -   day of the week
    -   time of the day
    -   staff member who made the error

-   Since the dependent attribute Type_of_Error has multiple values (levels), select one type of error, you will train your classifier

-   Check that the error is sufficiently represented in the dataset.

-   Clean and prepare your data, using the methods seen in class

-   Train your classifier.

-   Write a report documenting your work: Dataset description, machine learning method and why it is suitable, Training and testing datasets, and the model evaluation.

```{r}
# Lets you view document
# view(newICU)
```

```{r}
# Remove useless column
newICU <- subset(newICU, select= -...11)
```

```{r}
#Summarizes doc
summary(newICU)
```

```{r}
#Gives you the data types of features
str(newICU)
```

```{r}
#Displays doc
newICU
```

```{r}
# Factor 
newICU$`Date-of-error` <- as.Date(newICU$`Date-of-error`, tryFormats = c("%d-%m-%Y", "%d/%m/%y"))
#newICU$`Time-of-error` <- as.Date(newICU$`Time-of-error`, tryFormats = c("%h:%m"))
#newICU
#newICU$`Staff-type-initiated-error`[newICU$`Staff-type-initiated-error`.con]

```

```{r}
newICU$`Error-category` <- factor(newICU$`Error-category`)
```

```{r}
newICU$`Type-of-error` <- factor(newICU$`Type-of-error`)
newICU$`Cause-of-error` <- factor(newICU$`Cause-of-error`)
```

```{r}
newICU$`Contributing-factor` <- factor(newICU$`Contributing-factor`)
newICU$`Medication-process-node` <- factor(newICU$`Medication-process-node`)
newICU$`Staff-type-initiated-error` <- factor(newICU$`Staff-type-initiated-error`)
newICU$`Staff-type-perpetuated-error` <- factor(newICU$`Staff-type-perpetuated-error`)
newICU$`Action-taken` <- factor(newICU$`Action-taken`)
newICU$`Staff-type-discovered-error` <- factor(newICU$`Staff-type-discovered-error`)
newICU$`Day-of-week` <- factor(newICU$`Day-of-week`)
```

```{r}
summary(newICU)
```
```{r}
#newICU$`Cause-of-error`
```

```{r}
count_day_week <- newICU %>%
  count(`Day-of-week`)

ggplot(count_day_week, aes(x = `Day-of-week`, y = n)) +
         geom_bar(stat = 'identity') + geom_text(aes(label = n, vjust = -.45) )
```

```{r}
count_error_category <- newICU %>%
  count(`Error-category`)

```

```{r}
ggplot(count_error_category, aes(x = `Error-category`, y = n)) +
         geom_bar(stat = 'identity') + geom_text(aes(label = n, vjust = -.45) )
  
```

```{r}
pairs.panels(newICU[c('Type-of-error','Error-category', 'Day-of-week', 'Contributing-factor', 'Medication-process-node', 'Location-of-error', 'Type-of-error')])
```

```{r}
Improper_doseICU <- subset(newICU, `Type-of-error` =='Improper dose/quantity')
Improper_doseICU <- subset(Improper_doseICU, select= c(`Type-of-error`, `Error-category`,   `Day-of-week`, `Contributing-factor`, `Medication-process-node`, `Location-of-error`))
```


```{r}
pairs.panels(Improper_doseICU[c('Error-category', 'Day-of-week', 'Contributing-factor', 'Medication-process-node', 'Location-of-error')])

```

```{r}
set.seed(1000)
Improper_doseICU$`Day-of-week` <- as.factor(Improper_doseICU$`Day-of-week`)

test.size <- round(nrow(Improper_doseICU) * .3)
train.size <- round(nrow(Improper_doseICU) * .7)
```


```{r}
train.df <- Improper_doseICU[1:train.size,]
test.df <- Improper_doseICU[(train.size+1):(train.size+test.size),]
```
#### 9. Download the `rpart` for “Recursive Partitioning and Regression Trees” if it is not in your R base and bring it in your environment.
```{r}
pacman::p_load(rpart)
```

```{r}

#fit <- rpart(`Medication-process-node`  `Day-of-week` + `Error-category`,  data=train.df, method="class") 
fit <- rpart( `Location-of-error` ~ `Medication-process-node`  + `Day-of-week`, data=train.df, method="class") 
fit
```

```{r}
pacman::p_load(rattle, rpart.plot, RColorBrewer)

```

```{r}
fancyRpartPlot(fit)
```
```{r}

```